

@model IEnumerable<TangentWeb.Models.TangentItem>
@{
    ViewBag.Title = "Home";
}

@section Scripts {

    @Scripts.Render("~/bundles/knockout")


    <script type="text/javascript">

        @functions
        {
            public string TokenHeaderValue()
            {
                string cookieToken, formToken;
                AntiForgery.GetTokens(null, out cookieToken, out formToken);
                return cookieToken + ":" + formToken;                
            }
        }

        function TangentsViewModel() {

            var self = this;
            self.tangents = ko.observableArray([]);

            self.removeTangent = function (tangent) {
                var deleteUrl = "api/tangents/" + tangent.id;
                $.ajax({
                    type: "DELETE",
                    url: deleteUrl,
                    success: function () {
                        self.tangents.remove(tangent);
                    },
                    headers: {
                    'RequestVerificationToken': '@TokenHeaderValue()'
                    }
                });
            }

            $.getJSON("api/tangents", function (data) {
                self.tangents(data);
            });

        }

        var tangentsViewModel = new TangentsViewModel();

        ko.applyBindings(tangentsViewModel);

        ko.bindingHandlers.date = {
            update: function (element, valueAccessor, allBindingsAccessor, viewModel) {
                var value = valueAccessor();
                var formatString = allBindingsAccessor().formatString;
                var date = moment.utc(value).local();
                if (formatString == null) {
                    $(element).text(date.format("MMM D YYYY, h:mm:ss a"));
                }
                else {
                    $(element).text(date.format(formatString));
                }
            }
        };


        $(document).ready(function () {

            var bar = $('.bar');
            var percent = $('.percent');
            var status = $('#status');

            var options = {
                headers: {
                    'RequestVerificationToken': '@TokenHeaderValue()'
                },
                success: function (tangent) {
                    var percentVal = '100%';
                    bar.width(percentVal)
                    percent.html(percentVal);
                },
                beforeSend: function () {
                    status.empty();
                    var percentVal = '0%';
                    bar.width(percentVal)
                    percent.html(percentVal);

                    $('#progressBar').fadeIn();

                    status.html("Posting Tangent ...");
                },
                beforeSubmit: function () {
                    $('#status').fadeIn();

                    if ($('#tangentTitle').val() == '') {
                        status.html("Tangent must have text.");
                        return false;
                    } else if ($('#tangentText').val() == '') {
                        status.html("Tangent must have a title.");
                        return false;
                    }

                    // Tangents are allowed to not have photos. 
                    var file = $('#fileControl')[0].files[0];
                    if (file) {
                        if (file.size > 100000) {
                            status.html("File is too big. Please keep it under 100KB.");
                            return false;
                        } else if (file.type != "image/png" && file.type != "image/jpeg") {
                            status.html("File must be a JPEG or PNG image.");
                            return false;
                        }
                    }
                    return true;
                },
                uploadProgress: function (event, position, total, percentComplete) {
                    var percentVal = percentComplete + '%';
                    bar.width(percentVal)
                    percent.html(percentVal);
                },
                complete: function (xhr) {
                    status.html("Tangent posted!");
                    $('#status').fadeOut(5000, function () {
                        // Animation complete.
                        $('#progressBar').hide();
                    });

                    var fc = $('#fileControl');
                    fc.replaceWith(fc = fc.clone(true));
                    $('#tangentText').val('');
                    $('#tangentTitle').val('');
                }
            };

            $('#addTangent').ajaxForm(options);

        });
    </script>


    <script src="~/signalr/hubs"></script>
    <script type="text/javascript">
        $(function () {
            // Declare a proxy to reference the hub. 
            var tangentWeb = $.connection.tangentHub;

            tangentWeb.client.newTangentReceived = function (tangent) {
                tangentsViewModel.tangents.push(tangent);
            }

            $.connection.hub.start().done(function () {
                $("#Status").html("Connected");
            });
        });
    </script>
}

<ul id="tangents" data-bind="foreach: tangents">
    <li class="ui-widget-content ui-corner-all">
        <h1 data-bind="text: Title" class="ui-widget-header"></h1>
        <div><span data-bind="text: $data.Text || 'Text?'"></span></div>
        <div>
            <span data-bind="date: $data.Date || 'Date?'"></span>
        </div>
        <div>
            <span data-bind="text: $data.PosterId || 'PosterId?'"></span>
        </div>
        <div>
            <img data-bind="attr: { src: $data.ImageUrl }" />  
        </div>

        @if (Request.IsAuthenticated) 
        {
            <p><a data-bind="attr: { href: self }, click: $root.removeTangent" class="removeTangent ui-state-default ui-corner-all">Remove</a></p>
        }

    </li>
</ul>


@if (Request.IsAuthenticated) 
{
    using (Html.BeginForm("Tangents", "api", FormMethod.Post, new Dictionary<string, object> { { "id", "addTangent" }, { "enctype", "multipart/form-data" } }))
    {
        @Html.AntiForgeryToken()
    
        <fieldset>
            <legend>Add New Tangent</legend>
            <ol>
                <li>
                    <label for="Title">Title</label>
                    <input type="text" name="Title" id="tangentTitle"/>
                </li>
                <li>
                    <label for="Text">Text</label>
                    <input type="text" name="Text" id="tangentText">
                </li>
                <li>
                    <label for="photo">Photo</label>
                    <input name="photo" type="file" id="fileControl"/>
                </li>
            </ol>
            <input type="submit" value="Add" />
        </fieldset>
    
        <div id="progressBar" class="progress">
            <div class="bar"></div >
            <div class="percent">0%</div >
        </div>
    
        <div id="status"></div>
   
    }

}
else
{
    <h3>Welcome to Tangent.</h3>
}


